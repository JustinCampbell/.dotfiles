#!/bin/sh

NUM_LINES=10
IDLE=`top -l 1 | head -n 4 | tail -n 1 | awk '{printf "%3d%%\n", $7}'`
CPU=`expr 100 - ${IDLE%\%*}`
ACTIVE_LINES=$(($CPU/$NUM_LINES))
LINES=""
BAR_CHARACTER="‚ñà"
for (( i = 0; i < $NUM_LINES; i++ )); do
  if [[ $i < $ACTIVE_LINES ]]; then
    LINES="$LINES$BAR_CHARACTER"
  else
    LINES="$LINES "
  fi
done
CORE_COUNT=`sysctl -n hw.ncpu`
LOAD_AVERAGE=`uptime | awk '{ print $(NF-2) }'`

BATTERY=`pmset -g batt | grep "discharging" | cut -f 4 -d " "`
if [[ $BATTERY == "" ]]; then
  BATTERY="üîå"
else
  if [[ $BATTERY == "(no" ]]; then BATTERY="?:??"; fi

  if [[ $BATTERY =~ ^0: ]]; then
    BATTERY="~$BATTERY ‚ùóÔ∏èüîã"
  else
    BATTERY="~$BATTERY üîã"
  fi
fi

if ping -c 1 -s 1 -t 1 8.8.8.8 > /dev/null; then
  NETSTAT=" üì∂"
else
  NETSTAT=" ‚ùå"
fi

echo "$LOAD_AVERAGE/$CORE_COUNT |${LINES}| $BATTERY $NETSTAT "
